<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
    <script src="script.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="favicon.png" type="image/png" />
    <title>Guest Book</title>
    <!-- Tambahkan sebelum </head> -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" />
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
</head>

<body>
    <div class="container my-4">
        <h2 class="mb-4 text-center">Guest Book Dashboard</h2>
        <div class="mb-3 text-end">
            <button class="btn btn-danger" id="deleteAllBtn">
                <i class="fa fa-trash"></i> Hapus Semua Data
            </button>
        </div>
        <div class="table-responsive">
            <table id="guestbook-table" class="table table-bordered table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>No</th>
                        <th>Nama</th>
                        <th>Komentar</th>
                        <th>Foto</th>
                        <th>Waktu</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data akan diisi di sini -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Edit -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="editForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editKey" />
                    <div class="mb-3">
                        <label for="editName" class="form-label">Nama</label>
                        <input type="text" class="form-control" id="editName" required />
                    </div>
                    <div class="mb-3">
                        <label for="editComment" class="form-label">Komentar</label>
                        <input type="text" class="form-control" id="editComment" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            let table = $('#guestbook-table').DataTable({
                responsive: true,
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: 'Export Excel',
                        exportOptions: {
                            columns: [1, 2, 4] // hanya Nama, Komentar, Waktu
                        }
                    }
                ],
                columns: [
                    { data: null }, // Nomor urut
                    { data: 'name' },
                    { data: 'comment' },
                    {
                        data: 'photoUrl', render: function (data) {
                            return data ? `<img src="${data}" class="img-fluid rounded" style="max-width:80px;max-height:80px;" alt="Foto"/>` : '';
                        }
                    },
                    {
                        data: 'timestamp', render: function (data) {
                            return data ? new Date(data).toLocaleString() : '';
                        }
                    },
                    {
                        data: null, orderable: false, render: function (data, type, row) {
                            return `
        <button class="btn btn-sm btn-warning me-1" onclick="showEditModal('${row.key}', '${row.name}', '${row.comment}')">
            <i class="fa fa-edit"></i> Edit
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteEntry('${row.key}')">
            <i class="fa fa-trash"></i> Delete
        </button>
    `;
                        }
                    }
                ],
                order: [[4, 'asc']],
                columnDefs: [
                    {
                        targets: 0,
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        },
                        orderable: false
                    }
                ]
            });

            function loadTable() {
                fetch('/entries')
                    .then(res => res.json())
                    .then(data => {
                        let arr = [];
                        if (data) {
                            Object.entries(data).forEach(([key, entry]) => {
                                arr.push({ ...entry, key });
                            });
                            arr.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                        }
                        console.log('Data yang di-load:', arr); // Tambahkan ini
                        table.clear().rows.add(arr).draw();
                    });
            }
            loadTable();

            window.deleteEntry = function (key) {
                if (confirm('Yakin ingin menghapus data ini?')) {
                    fetch(`/entries/${key}`, { method: 'DELETE' })
                        .then(res => res.json())
                        .then(result => {
                            if (result.success) {
                                loadTable();
                            } else {
                                alert('Gagal menghapus data');
                            }
                        });
                }
            }

            $('#deleteAllBtn').on('click', function () {
                if (confirm('Yakin ingin menghapus SEMUA data?')) {
                    fetch('/entries-all', { method: 'DELETE' })
                        .then(res => res.json())
                        .then(result => {
                            if (result.success) {
                                loadTable();
                            } else {
                                alert('Gagal menghapus semua data');
                            }
                        });
                }
            });

            window.showEditModal = function (key, name, comment) {
                $('#editKey').val(key);
                $('#editName').val(name);
                $('#editComment').val(comment);
                var modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            }

            $('#editForm').on('submit', function (e) {
                e.preventDefault();
                const key = $('#editKey').val();
                const name = $('#editName').val();
                const comment = $('#editComment').val();
                fetch(`/entries/${key}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, comment })
                })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) {
                            var modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                            modal.hide();
                            loadTable();
                        } else {
                            alert('Gagal update data');
                        }
                    });
            });
        });
    </script>
</body>

</html>